<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.doooly.dao.reachad.AdOrderReportDao">


	<resultMap id="orderMap" type="com.doooly.business.order.vo.OrderVo">
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="order_id" property="orderId" jdbcType="BIGINT" />
		<result column="bussiness_id" property="bussinessId" jdbcType="BIGINT" />
		<result column="user_id" property="userId" jdbcType="BIGINT" />
		<result column="order_number" property="orderNumber" jdbcType="VARCHAR" />
		<result column="stores_id" property="storesId" jdbcType="VARCHAR" />
		<result column="total_mount" property="totalMount" jdbcType="DECIMAL" />
		<result column="total_price" property="totalPrice" jdbcType="DECIMAL" />
		<result column="order_date" property="orderDate" jdbcType="TIMESTAMP" />
		<result column="state" property="state" jdbcType="CHAR" />
		<result column="type" property="type" jdbcType="SMALLINT" />
		<result column="product_type" property="productType" jdbcType="SMALLINT" />
		<result column="is_user_rebate" property="isUserRebate" jdbcType="CHAR" />
		<result column="user_rebate" property="userRebate" jdbcType="DECIMAL" />
		<result column="user_return_amount" property="userReturnAmount" jdbcType="DECIMAL" />
		<result column="is_business_rebate" property="isBusinessRebate" jdbcType="CHAR" />
		<result column="business_rebate_amount" property="businessRebateAmount" jdbcType="DECIMAL" />
		<result column="billing_state" property="billingState" jdbcType="CHAR" />
		<result column="del_flag_user" property="delFlagUser" jdbcType="CHAR" />
		<result column="create_by" property="createBy" jdbcType="VARCHAR" />
		<result column="del_flag" property="delFlag" jdbcType="CHAR" />
		<result column="is_first" property="isFirst" jdbcType="INTEGER" />
		<result column="is_source" property="isSource" jdbcType="INTEGER" />
		<result column="first_count" property="firstCount" jdbcType="INTEGER" />
		<result column="air_settle_accounts" property="airSettleAccounts" jdbcType="DECIMAL" />
		<result column="remarks" property="remarks" jdbcType="VARCHAR" />
		<result column="update_date" property="updateDate" jdbcType="TIMESTAMP" />
		<result column="update_by" property="updateBy" jdbcType="VARCHAR" />
		<result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
		<result column="consignee_name" property="consigneeName" jdbcType="VARCHAR" />
		<result column="consignee_mobile" property="consigneeMobile" jdbcType="VARCHAR" />
		<result column="consignee_addr" property="consigneeAddr" jdbcType="VARCHAR" />
		<result column="product_type" property="productType" jdbcType="INTEGER" />
		<result column="act_type" property="actType" jdbcType="VARCHAR" />
		<result column="service_charge" property="serviceCharge" jdbcType="DECIMAL" />
		<result column="voucher" property="voucher" jdbcType="DECIMAL" />
		<result column="coupon_id" property="couponId" jdbcType="VARCHAR" />
		<result column="support_pay_type" property="supportPayType" jdbcType="VARCHAR" />
		<collection property="items" column="id" ofType="com.doooly.business.order.vo.OrderItemVo">
			<id column="did" property="id" jdbcType="BIGINT" />
			<result column="order_report_id" property="orderReportId" jdbcType="BIGINT" />
			<result column="category_id" property="categoryId" jdbcType="VARCHAR" />
			<result column="code" property="code" jdbcType="VARCHAR" />
			<result column="goods" property="goods" jdbcType="VARCHAR" />
			<result column="amount" property="amount" jdbcType="DECIMAL" />
			<result column="price" property="price" jdbcType="DECIMAL" />
			<result column="number" property="number" jdbcType="DECIMAL" />
			<result column="create_by" property="createBy" jdbcType="VARCHAR" />
			<result column="del_flag" property="delFlag" jdbcType="CHAR" />
			<result column="remarks" property="remarks" jdbcType="VARCHAR" />
			<result column="tax" property="tax" jdbcType="DECIMAL" />
			<result column="update_date" property="updateDate" jdbcType="TIMESTAMP" />
			<result column="update_by" property="updateBy" jdbcType="VARCHAR" />
			<result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
			<result column="sku" property="sku" jdbcType="VARCHAR" />
			<result column="product_sku_id" property="productSkuId" jdbcType="VARCHAR" />
			<result column="product_img" property="productImg" jdbcType="VARCHAR" />
			<result column="external_number" property="externalNumber" jdbcType="VARCHAR" />
            <result column="card_oid" property="cardOid" jdbcType="VARCHAR" />
		</collection>
	</resultMap>

	<resultMap id="orderListMap" type="com.doooly.business.myorder.po.OrderPoResp">
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="order_id" property="orderId" jdbcType="BIGINT" />
		<result column="bussiness_id" property="businessId" jdbcType="BIGINT" />
		<result column="user_id" property="userId" jdbcType="BIGINT" />
		<result column="order_number" property="orderNumber" jdbcType="VARCHAR" />

		<result column="total_mount" property="totalMount" jdbcType="DECIMAL" />
		<result column="total_price" property="totalPrice" jdbcType="DECIMAL" />
		<result column="savePrice" property="savePrice" jdbcType="DECIMAL" />

		<result column="order_date" property="orderDate" jdbcType="TIMESTAMP" />
		<result column="state" property="state" jdbcType="CHAR" />
		<result column="type" property="type" jdbcType="SMALLINT" />
		<result column="product_type" property="productType" jdbcType="INTEGER" />
		<result column="is_user_rebate" property="isUserRebate" jdbcType="CHAR" />
		<result column="user_rebate" property="userRebate" jdbcType="DECIMAL" />

		<result column="is_business_rebate" property="isBusinessRebate" jdbcType="CHAR" />

		<result column="is_source" property="isSource" jdbcType="INTEGER" />

		<result column="remarks" property="remarks" jdbcType="VARCHAR" />
	 		<result column="storeName" property="storeName" jdbcType="VARCHAR" />
	 			<result column="company" property="company" jdbcType="VARCHAR" />

	</resultMap>

	<resultMap id="orderDetailMap" type="com.doooly.business.myorder.po.OrderDetailReport">
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="order_id" property="orderId" jdbcType="BIGINT" />
		<result column="bussiness_id" property="bussinessId" jdbcType="BIGINT" />
		<result column="user_id" property="userId" jdbcType="BIGINT" />
		<result column="order_number" property="orderNumber" jdbcType="VARCHAR" />
		
		<result column="total_mount" property="totalMount" jdbcType="DECIMAL" />
		<result column="total_price" property="totalPrice" jdbcType="DECIMAL" />
		<result column="savePrice" property="savePrice" jdbcType="DECIMAL" />
		<result column="order_date" property="orderDate" jdbcType="TIMESTAMP" />
		<result column="state" property="state" jdbcType="CHAR" />
		<result column="type" property="type" jdbcType="SMALLINT" />
		<result column="product_type" property="productType" jdbcType="INTEGER" />
		<result column="is_user_rebate" property="isUserRebate" jdbcType="CHAR" />
		<result column="user_rebate" property="userRebate" jdbcType="DECIMAL" />

		<result column="is_business_rebate" property="isBusinessRebate" jdbcType="CHAR" />

		<result column="is_source" property="isSource" jdbcType="INTEGER" />

		<result column="remarks" property="remarks" jdbcType="VARCHAR" />
		<result column="storeName" property="storeName" jdbcType="VARCHAR" />
	 			<result column="company" property="company" jdbcType="VARCHAR" />


	</resultMap>


    <sql id="getAdOrderReportColumns">
        o.id AS "id",
        o.order_id AS "order_id",
        o.bussiness_id AS "bussiness_id",
        o.user_id AS "user_id",
        o.order_number AS "order_number",
        o.stores_id AS "stores_id ",
        o.total_mount AS "total_mount",
        o.total_price AS "total_price",
        o.order_date AS "order_date",
        o.state AS "state",
        o.type AS "type",
        o.is_user_rebate AS "is_user_rebate",
        IFNULL(o.user_rebate,0.00) AS "user_rebate",
        IFNULL(o.user_return_amount,0.00) AS "user_return_amount",
        o.is_business_rebate AS "is_business_rebate",
        IFNULL(o.business_rebate_amount,0.00) AS "business_rebate_amount",
        o.billing_state AS "billing_state",
        o.create_by AS "create_by",
        o.del_flag AS "del_flag",
        o.is_first AS "is_first",
        o.is_source AS "is_source",
        o.first_count AS "first_count",
        o.air_settle_accounts AS "air_settle_accounts",
        o.remarks AS "remarks",
        o.update_date AS "update_date",
        o.update_by AS "update_by",
        o.create_date AS "create_date",
        o.consignee_name AS "consignee_name",
        o.consignee_mobile AS "consignee_mobile",
        o.consignee_addr AS "consignee_addr",
        o.product_type AS "product_type",
        o.act_type AS "act_type",
        o.service_charge AS "service_charge",
        o.coupon_id AS "coupon_id",
        o.support_pay_type AS "support_pay_type",
        o.voucher AS "voucher"
    </sql>

    <sql id="adOrderDetailColumns">
        d.id AS "id",
        d.id AS "did",
        d.order_report_id AS "order_report_id",
        d.category_id AS "category_id",
        d.code AS "code",
        d.goods AS "goods",
        d.amount AS "amount",
        d.price AS "price",
        d.number AS "number",
        d.sku AS "sku",
        d.product_sku_id AS "product_sku_id",
        d.card_oid AS "card_oid",
        d.product_img AS "product_img",
        d.external_number AS "external_number",
        d.tax AS "tax",
        d.ret_msg AS "ret_msg",
        d.ret_code AS "ret_code",
        d.ret_state AS "ret_state",
        d.create_by AS "create_by",
        d.del_flag AS "del_flag",
        d.remarks AS "remarks",
        d.update_date AS "update_date",
        d.update_by AS "update_by",
        d.create_date AS "create_date"
    </sql>


	<!-- 注意:以下最好不要使用星号,暂时没有时间调整 -->

	<!--获得用户每天话费和流量充值的消费金额-->
	<select id="getConsumptionAmount" resultType="java.math.BigDecimal" >
		SELECT
            SUM(IF(o.type=1,o.amount,0)-IF(o.type=5,o.amount,0)) totalAmount
        FROM
            ad_order_report r,
            _order o
        WHERE
            r.order_number = o.orderNumber
        AND o.state = 1
        AND o.type in (1,5)
        AND o.payType = 0
        AND r.user_id = #{userId}
        AND r.product_type = 3
        AND DATE_FORMAT(r.order_date, '%Y-%m') = DATE_FORMAT(now(), '%Y-%m')
	</select>

	<!--获得用户每天话费和流量充值的消费金额-->
	<select id="getConsumptionAmountByMap" resultType="java.math.BigDecimal" parameterType="java.util.Map">
		SELECT
            SUM(IF(r.type=1,o.amount,0)-IF(r.type=5,o.amount,0)) totalAmount
        FROM
            ad_order_report r,
            ad_order_flow o
        WHERE
            r.id = o.order_report_id
        AND r.state = 1
        AND r.type in (1,5)
        AND o.pay_type = 0
        AND r.user_id = #{userId}
        AND r.product_type = 3
        <if test="firstDayOfMonth != null and firstDayOfMonth != ''">
            AND r.order_date &gt;= #{firstDayOfMonth}
        </if>
        <if test="lastDayOfMonth != null and lastDayOfMonth != ''">
            AND r.order_date &lt;= #{lastDayOfMonth}
        </if>
	</select>

	<!-- 获得用户未完成订单和完成订单的购买数量-->
	<select id="getByNum" resultType="java.lang.Integer" >
		select
		count(1)
		from
		ad_order_report r,
		ad_order_detail d
		where
		r.id = d.order_report_id
		and d.product_sku_id like concat('%',#{skuId})
		and	r.user_id = #{userId}
		and r.act_type= #{actType}
		and r.type = '1'
	</select>

	<!-- 获得用户未完成订单和完成订单的购买数量-->
	<select id="getBuyNum" resultType="java.lang.Integer" parameterType="java.util.Map">
		select
		count(1)
		from
		ad_order_report r,
		ad_order_detail d
		where
		r.id = d.order_report_id
		and d.product_sku_id = #{paramMap.productSkuId}
		and	r.user_id = #{paramMap.userId}
		and r.act_type= #{paramMap.actType}
		and r.type = '1'
	</select>

	<select id="getByOrderNum" resultMap="orderMap" >
		select
			o.*,
			d.*,
			d.id did
		from
			ad_order_report o,ad_order_detail d
		where
			o.id = d.order_report_id
			and o.order_number = #{orderNumber}
			and o.del_flag = '0'
	</select>

	<select id="getById" resultMap="orderMap" >
		select
		o.*,
		d.*,
		d.id did
		from
		ad_order_report o,ad_order_detail d
		where
		o.id = d.order_report_id
		and o.id = #{orderId}
		and o.del_flag = '0'
	</select>

	<select id="getOrder" resultMap="orderMap" parameterType="com.doooly.business.order.vo.OrderVo">
		select
		o.*,
		d.*,
		d.id did
		from
		ad_order_report o,ad_order_detail d
		<where>
			and o.id = d.order_report_id
			<if test="orderId != null and orderId != ''" >
				and o.order_id = #{orderId,jdbcType=BIGINT}
			</if>
			<if test="bussinessId != null and bussinessId != ''" >
				and o.bussiness_id = #{bussinessId,jdbcType=BIGINT}
			</if>
			<if test="userId != null and userId != ''" >
				and o.user_id = #{userId,jdbcType=BIGINT}
			</if>
			<if test="orderNumber != null and orderNumber != ''" >
				and o.order_number = #{orderNumber,jdbcType=VARCHAR}
			</if>
			<if test="storesId != null and storesId != ''" >
				and o.stores_id = #{storesId,jdbcType=VARCHAR}
			</if>
			<if test="state != null and state != ''" >
				and o.state = #{state,jdbcType=CHAR}
			</if>
			<if test="type != null and type != ''" >
				and o.type = #{type,jdbcType=SMALLINT}
			</if>
			<if test="productType != null and productType != ''" >
				and o.product_type = #{productType,jdbcType=SMALLINT}
			</if>
			<if test="createBy != null and createBy != ''" >
				and o.create_by = #{createBy,jdbcType=VARCHAR}
			</if>
			<if test="isSource != null and isSource != ''" >
				and o.is_source = #{isSource,jdbcType=INTEGER}
			</if>
			<if test="updateBy != null and updateBy != ''" >
				and o.update_by = #{updateBy,jdbcType=VARCHAR}
			</if>
			<if test="consigneeName != null and consigneeName != ''" >
				and o.consignee_name = #{consigneeName,jdbcType=VARCHAR}
			</if>
			<if test="consigneeMobile != null and consigneeMobile != ''" >
				and o.consignee_mobile = #{consigneeMobile,jdbcType=VARCHAR}
			</if>
			<if test="consigneeAddr != null and consigneeAddr != ''" >
				and o.consignee_addr = #{consigneeAddr,jdbcType=VARCHAR}
			</if>
		</where>

	</select>


	<select id="getOrderLimt" resultMap="orderMap" parameterType="com.doooly.business.order.vo.OrderVo">
		select
        <include refid="getAdOrderReportColumns" />,
        <include refid="adOrderDetailColumns" />
		from
		ad_order_report o,ad_order_detail d
		<where>
			and o.id = d.order_report_id
			<if test="orderId != null and orderId != ''" >
				and o.order_id = #{orderId,jdbcType=BIGINT}
			</if>
			<if test="bussinessId != null and bussinessId != ''" >
				and o.bussiness_id = #{bussinessId,jdbcType=BIGINT}
			</if>
			<if test="userId != null and userId != ''" >
				and o.user_id = #{userId,jdbcType=BIGINT}
			</if>
			<if test="orderNumber != null and orderNumber != ''" >
				and o.order_number = #{orderNumber,jdbcType=VARCHAR}
			</if>
			<if test="storesId != null and storesId != ''" >
				and o.stores_id = #{storesId,jdbcType=VARCHAR}
			</if>
			<if test="state != null and state != ''" >
				and o.state = #{state,jdbcType=CHAR}
			</if>
			<if test="type != null and type != ''" >
				and o.type = #{type,jdbcType=SMALLINT}
			</if>
			<if test="productType != null and productType != ''" >
				and o.product_type = #{productType,jdbcType=SMALLINT}
			</if>
			<if test="createBy != null and createBy != ''" >
				and o.create_by = #{createBy,jdbcType=VARCHAR}
			</if>
			<if test="isSource != null and isSource != ''" >
				and o.is_source = #{isSource,jdbcType=INTEGER}
			</if>
			<if test="updateBy != null and updateBy != ''" >
				and o.update_by = #{updateBy,jdbcType=VARCHAR}
			</if>
			<if test="consigneeName != null and consigneeName != ''" >
				and o.consignee_name = #{consigneeName,jdbcType=VARCHAR}
			</if>
			<if test="consigneeMobile != null and consigneeMobile != ''" >
				and o.consignee_mobile = #{consigneeMobile,jdbcType=VARCHAR}
			</if>
			<if test="consigneeAddr != null and consigneeAddr != ''" >
				and o.consignee_addr = #{consigneeAddr,jdbcType=VARCHAR}
			</if>
		</where>
        limit 1
	</select>

	<insert id="insert" useGeneratedKeys="true" keyProperty="id" parameterType="com.doooly.business.order.vo.OrderVo">
		INSERT INTO ad_order_report(
		id,
		order_id,
		bussiness_id,
		user_id,
		order_number,
		stores_id,
		total_mount,
		total_price,
		order_date,
		state,
		type,
		is_user_rebate,
		user_rebate,
		user_return_amount,
		is_business_rebate,
		business_rebate_amount,
		billing_state,
		del_flag_user,
		create_by,
		del_flag,
		is_first,
		is_source,
		first_count,
		air_settle_accounts,
		remarks,
		update_date,
		update_by,
		create_date,
		consignee_name,
		consignee_mobile,
		consignee_addr,
		product_type,
		act_type,
		service_charge,
		voucher,
		coupon_id,
		support_pay_type,
		big_order_number
		) VALUES (
		#{id},
		#{orderId},
		#{bussinessId},
		#{userId},
		#{orderNumber},
		#{storesId},
		#{totalMount},
		#{totalPrice},
		#{orderDate},
		#{state},
		#{type},
		#{isUserRebate},
		#{userRebate},
		#{userReturnAmount},
		#{isBusinessRebate},
		#{businessRebateAmount},
		#{billingState},
		#{delFlagUser},
		#{createBy},
		#{delFlag},
		#{isFirst},
		#{isSource},
		#{firstCount},
		#{airSettleAccounts},
		#{remarks},
		#{updateDate},
		#{updateBy},
		#{createDate},
		#{consigneeName},
		#{consigneeMobile},
		#{consigneeAddr},
		#{productType},
		#{actType},
		#{serviceCharge},
		#{voucher},
		#{couponId},
		#{supportPayType},
		#{bigOrderNumber}
		)
	</insert>

	<!-- 取消订单 -->
	<update id="cancleOrder" parameterType="com.doooly.business.order.vo.OrderVo">
		update ad_order_report
		<set >
			<if test="type != null and type != ''" >
				type = #{type,jdbcType=BIGINT},
			</if>
			<if test="state != null and state != ''" >
				state = #{state,jdbcType=BIGINT},
			</if>
			update_date = now(),
		</set>
		where order_number = #{orderNumber} and user_id = #{userId} and del_flag = '0'
	</update>

	<update id="update" parameterType="com.doooly.business.order.vo.OrderVo">
		update ad_order_report
		<set >
			update_date = now(),
			<if test="orderId != null and orderId != ''" >
				order_id = #{orderId,jdbcType=BIGINT},
			</if>
			<if test="bussinessId != null and bussinessId != ''" >
				bussiness_id = #{bussinessId,jdbcType=BIGINT},
			</if>
			<if test="userId != null and userId != ''" >
				user_id = #{userId,jdbcType=BIGINT},
			</if>
			<if test="orderNumber != null and orderNumber != ''" >
				order_number = #{orderNumber,jdbcType=VARCHAR},
			</if>
			<if test="storesId != null and storesId != ''" >
				stores_id = #{storesId,jdbcType=VARCHAR},
			</if>
			<if test="totalMount != null and totalMount != ''" >
				total_mount = #{totalMount,jdbcType=DECIMAL},
			</if>
			<if test="totalPrice != null and totalPrice != ''" >
				total_price = #{totalPrice,jdbcType=DECIMAL},
			</if>
			<if test="orderDate != null and orderDate != ''" >
				order_date = #{orderDate,jdbcType=TIMESTAMP},
			</if>
			<if test="state != null and state != ''" >
				state = #{state,jdbcType=CHAR},
			</if>
			<if test="type != null and type != ''" >
				type = #{type,jdbcType=SMALLINT},
			</if>
			<if test="productType != null and productType != ''" >
				product_type = #{productType,jdbcType=SMALLINT},
			</if>
			<if test="isUserRebate != null and isUserRebate != ''" >
				is_user_rebate = #{isUserRebate,jdbcType=CHAR},
			</if>
			<if test="userRebate != null and userRebate != ''" >
				user_rebate = #{userRebate,jdbcType=DECIMAL},
			</if>
			<if test="userReturnAmount != null and userReturnAmount != ''" >
				user_return_amount = #{userReturnAmount,jdbcType=DECIMAL},
			</if>
			<if test="isBusinessRebate != null and isBusinessRebate != ''" >
				is_business_rebate = #{isBusinessRebate,jdbcType=CHAR},
			</if>
			<if test="businessRebateAmount != null and businessRebateAmount != ''" >
				business_rebate_amount = #{businessRebateAmount,jdbcType=DECIMAL},
			</if>
			<if test="billingState != null and billingState != ''" >
				billing_state = #{billingState,jdbcType=CHAR},
			</if>
			<if test="delFlagUser != null and delFlagUser != ''" >
				del_flag_user = #{delFlagUser,jdbcType=CHAR},
			</if>
			<if test="createBy != null and createBy != ''" >
				create_by = #{createBy,jdbcType=VARCHAR},
			</if>
			<if test="delFlag != null and delFlag != ''" >
				del_flag = #{delFlag,jdbcType=CHAR},
			</if>
			<if test="isFirst != null and isFirst != ''" >
				is_first = #{isFirst,jdbcType=INTEGER},
			</if>
			<if test="isSource != null and isSource != ''" >
				is_source = #{isSource,jdbcType=INTEGER},
			</if>
			<if test="firstCount != null and firstCount != ''" >
				first_count = #{firstCount,jdbcType=INTEGER},
			</if>
			<if test="airSettleAccounts != null and airSettleAccounts != ''" >
				air_settle_accounts = #{airSettleAccounts,jdbcType=DECIMAL},
			</if>
			<if test="remarks != null and remarks != ''" >
				remarks = #{remarks,jdbcType=VARCHAR},
			</if>
			<if test="updateBy != null and updateBy != ''" >
				update_by = #{updateBy,jdbcType=VARCHAR},
			</if>
			<if test="createDate != null and createDate != ''" >
				create_date = #{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="consigneeName != null and consigneeName != ''" >
				consignee_name = #{consigneeName,jdbcType=VARCHAR},
			</if>
			<if test="consigneeMobile != null and consigneeMobile != ''" >
				consignee_mobile = #{consigneeMobile,jdbcType=VARCHAR},
			</if>
			<if test="consigneeAddr != null and consigneeAddr != ''" >
				consignee_addr = #{consigneeAddr,jdbcType=VARCHAR},
			</if>
			<if test="productType != null and productType != ''" >
				product_type = #{productType,jdbcType=VARCHAR},
			</if>
			<if test="actType != null and actType != ''" >
				act_type = #{actType,jdbcType=VARCHAR},
			</if>
		</set>
		where id = #{id,jdbcType=BIGINT}
	</update>

	<update id="updateByNum" parameterType="com.doooly.business.order.vo.OrderVo">
		update ad_order_report
		<set >
			update_date = now(),
			<if test="orderId != null and orderId != ''" >
				order_id = #{orderId,jdbcType=BIGINT},
			</if>
			<if test="bussinessId != null and bussinessId != ''" >
				bussiness_id = #{bussinessId,jdbcType=BIGINT},
			</if>
			<if test="userId != null and userId != ''" >
				user_id = #{userId,jdbcType=BIGINT},
			</if>
			<if test="orderNumber != null and orderNumber != ''" >
				order_number = #{orderNumber,jdbcType=VARCHAR},
			</if>
			<if test="storesId != null and storesId != ''" >
				stores_id = #{storesId,jdbcType=VARCHAR},
			</if>
			<if test="totalMount != null and totalMount != ''" >
				total_mount = #{totalMount,jdbcType=DECIMAL},
			</if>
			<if test="totalPrice != null and totalPrice != ''" >
				total_price = #{totalPrice,jdbcType=DECIMAL},
			</if>
			<if test="orderDate != null and orderDate != ''" >
				order_date = #{orderDate,jdbcType=TIMESTAMP},
			</if>
			<if test="state != null and state != ''" >
				state = #{state,jdbcType=CHAR},
			</if>
			<if test="type != null and type != ''" >
				type = #{type,jdbcType=SMALLINT},
			</if>
			<if test="productType != null and productType != ''" >
				product_type = #{productType,jdbcType=SMALLINT},
			</if>
			<if test="isUserRebate != null and isUserRebate != ''" >
				is_user_rebate = #{isUserRebate,jdbcType=CHAR},
			</if>
			<if test="userRebate != null and userRebate != ''" >
				user_rebate = #{userRebate,jdbcType=DECIMAL},
			</if>
			<if test="userReturnAmount != null and userReturnAmount != ''" >
				user_return_amount = #{userReturnAmount,jdbcType=DECIMAL},
			</if>
			<if test="isBusinessRebate != null and isBusinessRebate != ''" >
				is_business_rebate = #{isBusinessRebate,jdbcType=CHAR},
			</if>
			<if test="businessRebateAmount != null and businessRebateAmount != ''" >
				business_rebate_amount = #{businessRebateAmount,jdbcType=DECIMAL},
			</if>
			<if test="billingState != null and billingState != ''" >
				billing_state = #{billingState,jdbcType=CHAR},
			</if>
			<if test="delFlagUser != null and delFlagUser != ''" >
				del_flag_user = #{delFlagUser,jdbcType=CHAR},
			</if>
			<if test="createBy != null and createBy != ''" >
				create_by = #{createBy,jdbcType=VARCHAR},
			</if>
			<if test="delFlag != null and delFlag != ''" >
				del_flag = #{delFlag,jdbcType=CHAR},
			</if>
			<if test="isFirst != null and isFirst != ''" >
				is_first = #{isFirst,jdbcType=INTEGER},
			</if>
			<if test="isSource != null and isSource != ''" >
				is_source = #{isSource,jdbcType=INTEGER},
			</if>
			<if test="firstCount != null and firstCount != ''" >
				first_count = #{firstCount,jdbcType=INTEGER},
			</if>
			<if test="airSettleAccounts != null and airSettleAccounts != ''" >
				air_settle_accounts = #{airSettleAccounts,jdbcType=DECIMAL},
			</if>
			<if test="remarks != null and remarks != ''" >
				remarks = #{remarks,jdbcType=VARCHAR},
			</if>
			<if test="updateBy != null and updateBy != ''" >
				update_by = #{updateBy,jdbcType=VARCHAR},
			</if>
			<if test="createDate != null and createDate != ''" >
				create_date = #{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="consigneeName != null and consigneeName != ''" >
				consignee_name = #{consigneeName,jdbcType=VARCHAR},
			</if>
			<if test="consigneeMobile != null and consigneeMobile != ''" >
				consignee_mobile = #{consigneeMobile,jdbcType=VARCHAR},
			</if>
			<if test="consigneeAddr != null and consigneeAddr != ''" >
				consignee_addr = #{consigneeAddr,jdbcType=VARCHAR},
			</if>
			<if test="productType != null and productType != ''" >
				product_type = #{productType,jdbcType=VARCHAR},
			</if>
			<if test="actType != null and actType != ''" >
				act_type = #{actType,jdbcType=VARCHAR},
			</if>
		</set>
		where order_number = #{orderNumber,jdbcType=BIGINT}
	</update>

	<!--获得用户某种sku的订单 -->
	<select id="getByUserSku" resultType="java.util.Map">
		select
		o.type,o.consignee_mobile consigneeMobile,d.identity_card identityCard,d.apply_card_area1 applyCardArea1,d.apply_card_store1 applyCardStore1
		from
		ad_order_report o
		inner join
		ad_order_detail i on o.id = i.order_report_id
		left join
		ad_order_delivery d on o.id = d.order_report_id
		WHERE
		i.product_sku_id = #{productSku} and o.user_id= #{userId} and o.del_flag='0';
	</select>
	<!--获得用户某种sku的订单 -->
	<select id="findUserIsBuyByProductAndSkuId" resultType="java.lang.String">
		select r.id from ad_order_report r INNER JOIN ad_order_detail d on r.id = d.order_report_id where r.user_id=#{userId} and (d.product_sku_id =#{productSkuId} or d.product_sku_id =#{productSku})
		and r.type=1 limit 1

	</select>


    <select id="getTotalNum" parameterType="com.doooly.entity.reachad.AdOrderReport" resultType="java.lang.Integer">
        SELECT
            count(1)
        FROM ad_order_report a
        LEFT JOIN ad_business b ON b.id = a.bussiness_id
        LEFT JOIN ad_business_store abs ON a.stores_id = abs.store_number AND a.bussiness_id = abs.business_id
        <where>
            a.del_flag = 0
            <if test="adBusiness != null and adBusiness.businessId != null and adBusiness.businessId != ''">
                AND (
                b.business_id LIKE concat('%',#{adBusiness.businessId},'%')
                )
            </if>
            <if test="adUser != null and adUser.id != null and adUser.id != ''">
                AND a.user_id = #{adUser.id}
            </if>
            <if test="beginOrderDate != null and beginOrderDate != ''">
                AND a.order_date &gt;= #{beginOrderDate}
            </if>
            <if test="endOrderDate != null and endOrderDate != ''">
                AND a.order_date &lt;= #{endOrderDate}
            </if>
            <choose>
                <when test="state != null and state != '' and state ==1">
                    AND a.state = 1 AND a.type = 1
                </when>
                <when test="state != null and state != '' and state ==2">
                    AND ((a.state = 1 AND a.type = 5) OR (a.state = 2 AND a.type=99))
                </when>
                <when test="state != null and state != '' and state ==0">
                    AND a.state = 0 and a.type= 10
                </when>
                <otherwise>
                    AND ((a.state = 1 AND a.type in (1,5)) OR (a.state = 0 AND a.type=10) OR (a.state = 2 AND a.type=99))
                </otherwise>
            </choose>
            <if test="type != null and type != ''">
                AND a.type = #{type}
            </if>
            <if test="delFlagUser != null and delFlagUser != ''"> AND a.del_flag_user = #{delFlagUser} </if>
        </where>
    </select>

    <!--app我的订单新接口-->
    <select id="findOrderList" resultType="com.doooly.entity.reachad.AdOrderReport">
        SELECT
        a.id AS "id",
        a.bussiness_id AS "adBusiness.id",
        b.business_id AS "adBusiness.businessId",
        b.company AS "adBusiness.company",
        b.logo AS "adBusiness.logo",
        abs.store_name AS "adBusiness.storeName",
        a.state AS "state",
        a.type AS "type",
        a.order_number AS "orderNumber",
        a.order_date AS "orderDate",
        IFNULL(a.user_rebate,0.00) AS "userRebate",
        IFNULL(a.user_return_amount,0.00) AS "userReturnAmount",
        a.billing_state AS "billingState",
        a.is_source AS "isSource",
        a.total_mount AS "totalMount",
        a.total_price AS "totalPrice",
        a.total_price-a.total_mount AS "savePrice",
        a.product_type AS "productType"
        FROM ad_order_report a
        LEFT JOIN ad_business b ON b.id = a.bussiness_id
        LEFT JOIN ad_business_store abs ON a.stores_id = abs.store_number AND a.bussiness_id = abs.business_id
		LEFT JOIN ad_order_source aos ON a.order_number = aos.order_number
        <where>
            a.del_flag = 0
            <if test="adBusiness != null and adBusiness.businessId != null and adBusiness.businessId != ''">
                AND (
                b.business_id LIKE concat('%',#{adBusiness.businessId},'%')
                )
            </if>
            <if test="adUser != null and adUser.id != null and adUser.id != ''">
                AND a.user_id = #{adUser.id}
            </if>
            <if test="beginOrderDate != null and beginOrderDate != ''">
                AND a.order_date &gt;= #{beginOrderDate}
            </if>
            <if test="endOrderDate != null and endOrderDate != ''">
                AND a.order_date &lt;= #{endOrderDate}
            </if>
            <choose>
                <when test="state != null and state != '' and state ==1">
                    AND a.state = 1 AND a.type = 1
                </when>
                <when test="state != null and state != '' and state ==2">
                    AND ((a.state = 1 AND a.type = 5) OR (a.state = 2 AND a.type=99))
                </when>
                <when test="state != null and state != '' and state ==0">
                    AND a.state = 0 and a.type= 10
                </when>
                <otherwise>
                    AND ((a.state = 1 AND a.type in (1,5)) OR (a.state = 0 AND a.type=10) OR (a.state = 2 AND a.type=99))
                </otherwise>
            </choose>
            <if test="type != null and type != ''">
                AND a.type = #{type}
            </if>
            <if test="delFlagUser != null and delFlagUser != ''"> AND a.del_flag_user = #{delFlagUser} </if>
        </where>
                ORDER BY a.order_date DESC
        LIMIT #{startIndex},#{pageSize}
    </select>


    <!--app月份金额统计接口-->
    <select id="findOrderSum" resultType="com.doooly.entity.reachad.AdOrderReport">
        SELECT
        SUM(a.total_mount) AS "totalMonthMount",
        SUM( a.total_price-a.total_mount) AS "totalMonthsaveMount"
        FROM ad_order_report a
        LEFT JOIN ad_business b ON b.id = a.bussiness_id
        <where>
            a.del_flag = 0
            <if test="adBusiness != null and adBusiness.businessId != null and adBusiness.businessId != ''">
                AND (
                b.business_id LIKE concat('%',#{adBusiness.businessId},'%')
                )
            </if>
            <if test="adUser != null and adUser.id != null and adUser.id != ''">
                AND a.user_id = #{adUser.id}
            </if>
            <if test="beginOrderDate != null and beginOrderDate != ''">
                AND a.order_date &gt;= #{beginOrderDate}
            </if>
            <if test="endOrderDate != null and endOrderDate != ''">
                AND a.order_date &lt;= #{endOrderDate}
            </if>
            <choose>
                <when test="state != null and state != '' and state ==1">
                    AND a.state = 1 AND a.type = 1
                </when>
                <when test="state != null and state != '' and state ==2">
                    AND ((a.state = 1 AND a.type = 5) OR (a.state = 2 AND a.type=99))
                </when>
                <when test="state != null and state != '' and state ==0">
                    AND a.state = 0 and a.type= 10
                </when>
                <otherwise>
                    AND ((a.state = 1 AND a.type in (1,5)) OR (a.state = 0 AND a.type=10) OR (a.state = 2 AND a.type=99))
                </otherwise>
            </choose>
            <if test="type != null and type != ''">
                AND a.type = #{type}
            </if>
            <if test="delFlagUser != null and delFlagUser != ''"> AND a.del_flag_user = #{delFlagUser} </if>
        </where>
                ORDER BY a.order_date DESC

    </select>

    <select id="findOrderSumByMonth" resultType="java.util.Map">
        SELECT
        DATE_FORMAT(order_date,'%Y-%m') 'orderDate',
        SUM(a.total_mount) AS "totalMonthMount",
        SUM( a.total_price-a.total_mount) AS "totalMonthsaveMount"
        FROM ad_order_report a
        LEFT JOIN ad_business b ON b.id = a.bussiness_id
        <where>
            a.del_flag = 0
            <if test="adBusiness != null and adBusiness.businessId != null and adBusiness.businessId != ''">
                AND (
                b.business_id LIKE concat('%',#{adBusiness.businessId},'%')
                )
            </if>
            <if test="adUser != null and adUser.id != null and adUser.id != ''">
                AND a.user_id = #{adUser.id}
            </if>
            <choose>
                <when test="state != null and state != '' and state ==1">
                    AND a.state = 1 AND a.type = 1
                </when>
                <when test="state != null and state != '' and state ==2">
                    AND ((a.state = 1 AND a.type = 5) OR (a.state = 2 AND a.type=99))
                </when>
                <when test="state != null and state != '' and state ==0">
                    AND a.state = 0 and a.type= 10
                </when>
                <otherwise>
                    AND ((a.state = 1 AND a.type in (1,5)) OR (a.state = 0 AND a.type=10) OR (a.state = 2 AND a.type=99))
                </otherwise>
            </choose>
            <if test="type != null and type != ''">
                AND a.type = #{type}
            </if>
            <if test="delFlagUser != null and delFlagUser != ''"> AND a.del_flag_user = #{delFlagUser} </if>
        </where>
        GROUP BY YEAR (order_date), MONTH (order_date)
        ORDER BY a.order_date DESC
    </select>

    <select id="getDetailByOrderReportId" resultType="com.doooly.entity.reachad.AdOrderReport">
        SELECT
        d.goods AS "goods",
        d.sku AS "specification",
        d.product_img AS "productImg"
        FROM ad_order_detail d
        LEFT JOIN ad_order_report r
        ON d.order_report_id = r.id
        WHERE r.id = #{id}
        LIMIT 1
    </select>

    <select id="getPayFlowInfo" resultType="java.lang.String">
        SELECT f.pay_type AS "payType"
        FROM ad_pay_flow f
        WHERE f.order_number = #{orderNumber}
    </select>

    <sql id="getOrderDetailInfoColumns">
        a.id AS "id",
        a.order_id AS "orderId",
        a.bussiness_id AS "adBusiness.id",
        a.user_id AS "adUser.id",
        a.order_number AS "orderNumber",
        a.stores_id AS "storesId",
        a.total_mount AS "totalMount",
        a.total_price AS "totalPrice",
        a.order_date AS "orderDate",
        a.state AS "state",
        a.type AS "type",
        a.is_user_rebate AS "isUserRebate",
        IFNULL(a.user_rebate,0.00) AS "userRebate",
        IFNULL(a.user_return_amount,0.00) AS "userReturnAmount",
        a.is_business_rebate AS "isBusinessRebate",
        IFNULL(a.business_rebate_amount,0.00) AS "businessRebateAmount",
        a.billing_state AS "billingState",
        a.del_flag AS "delFlag",
        a.is_source AS "isSource",
        b.business_id AS "adBusiness.businessId",
        b.company AS "adBusiness.company",
        b.logo AS "adBusiness.logo",
        abs.store_name AS "adBusiness.storeName",
        a.total_price-a.total_mount AS "savePrice",
        a.product_type AS "productType",
        a.consignee_mobile AS "consigneeMobile",
        a.service_charge AS "serviceCharge",
        a.voucher AS "voucher"
    </sql>

    <sql id="OrderDetailInfoJoins">
        LEFT JOIN ad_business b ON b.id = a.bussiness_id
        LEFT JOIN ad_business_store abs ON a.stores_id = abs.store_number AND a.bussiness_id = abs.business_id
    </sql>

    <select id="getOrderDetailInfoById" resultType="com.doooly.entity.reachad.AdOrderReport">
        SELECT
        <include refid="getOrderDetailInfoColumns"/>
        FROM ad_order_report a
        <include refid="OrderDetailInfoJoins"/>
        WHERE a.id = #{orderReportId}
    </select>

    <select id="findSctcdAccount" resultType="com.doooly.entity.reachad.AdUserBusinessExpansion">
        SELECT
        aube.id AS "id",
        aube.user_id AS "userId",
        aube.business_id AS "businessId",
        aube.business_type AS "businessType",
        aube.f1, aube.f2, aube.f3, aube.f4,  aube.f5,
        aube.f6, aube.f7, aube.f8, aube.f9, aube.f10,
        aube.f11, aube.f12, aube.f13, aube.f14,  aube.f15,
        aube.create_date AS "createDate",
        aube.del_flag AS "delFlag"
        FROM ad_order_report r
        LEFT JOIN ad_user_business_expansion aube
        ON r.user_id = aube.user_id AND r.bussiness_id = aube.business_id AND r.remarks = aube.f1
        WHERE r.id = #{id}
        ORDER BY r.create_date DESC limit 1;
    </select>
    
    <select id="getOrderReportIdByOrderNum" resultType="com.doooly.entity.reachad.AdOrderReport">
        SELECT
        a.id
        FROM ad_order_report a
        WHERE a.order_number = #{orderNumber}
    </select>

	<select id="getGroupNumByOrderNum" resultType="java.lang.String" parameterType="java.lang.String">
		select u.group_num as groupNum from ad_order_report ar
		LEFT JOIN ad_user u on ar.user_id = u.id
		where ar.order_number = #{orderNumber}
	</select>

	<select id="orderBelongOneActivity" parameterType="java.util.Map" resultType="int">
		select count(ar.id) from ad_order_report ar
		LEFT JOIN ad_user u on ar.user_id = u.id
		INNER JOIN ad_group_self_product_price  asp
		 on asp.group_id = u.group_num and
		asp.activity_name = #{activityName}
		where ar.order_number = #{orderNum};
	</select>


      <sql id="order_column_sql">
	        a.id AS "id",
	        b.logo AS "logo",
	        abs.store_name AS "storeName",
	        b.company AS "company",

	        a.user_id AS "userId",


	        a.state AS "state",
	        a.type AS "type",
	        a.order_number AS "orderNumber",
	        a.order_date AS "orderDate",
	        a.bussiness_id AS "businessId",
	        a.is_user_rebate AS "isUserRebate",
	        IFNULL(a.user_rebate,0.00) AS "userRebate",
	        IFNULL(a.user_return_amount,0.00) AS "userReturnAmount",
	        a.billing_state AS "billingState",
	        a.is_source AS "isSource",
	        a.total_mount AS "totalMount",
	        a.total_price AS "totalPrice",
	        a.total_price-a.total_mount AS "savePrice",
	        a.product_type AS "productType",
	        IFNULL(aos.cash_desk_source,'m') AS "cashDeskSource"

	     </sql>

      <!--我的订单列表(所有订单，最近订单，最近到账)-->
    <select id="findALLOrderList" parameterType="com.doooly.business.myorder.po.OrderPoReq" resultMap="orderListMap">
    	SELECT
         <include refid="order_column_sql"/>
        FROM ad_order_report a
        LEFT JOIN ad_business b ON b.id = a.bussiness_id
        LEFT JOIN ad_business_store abs ON a.stores_id = abs.store_number  AND a.bussiness_id = abs.business_id
     	 LEFT JOIN ad_order_source aos ON a.order_number = aos.order_number
        <where>
           a.user_id = #{userId}
            <if test="beginOrderDate != null and beginOrderDate != ''">
                AND a.order_date &gt;= #{beginOrderDate}
            </if>
            <if test="endOrderDate != null and endOrderDate != ''">
                AND a.order_date &lt;= #{endOrderDate}
            </if>
            <if test="isUserRebate !=null and  isUserRebate!=''">
            	AND  a.is_user_rebate = #{isUserRebate}
            </if>
             <if test="businessId != null and businessId != ''">
                AND 
                a.bussiness_id =#{businessId}
                
            </if>
        </where>
         and a.del_flag = 0
         ORDER BY a.order_date DESC
        LIMIT #{startIndex},#{pageSize}
    </select>

     <!--我的订单列表(最近到账)-->
    <select id="findLatestOrderAmountList" parameterType="com.doooly.business.myorder.po.OrderPoReq" resultMap="orderListMap">
         SELECT
         <include refid="order_column_sql"/>
        FROM ad_order_report a
        LEFT JOIN ad_business b ON b.id = a.bussiness_id
        LEFT JOIN ad_business_store abs ON a.stores_id = abs.store_number  AND a.bussiness_id = abs.business_id
        LEFT JOIN ad_order_source aos ON a.order_number = aos.order_number
        <where>
            a.user_id = #{userId}
             <if test="businessId != null and businessId != ''">
                AND 
                a.bussiness_id =#{businessId}
                
            </if>
            <if test="beginOrderDate != null and beginOrderDate != ''">
                AND a.order_date &gt;= #{beginOrderDate}
            </if>
            <if test="endOrderDate != null and endOrderDate != ''">
                AND a.order_date &lt;= #{endOrderDate}
            </if>
            AND a.type = 1
			AND a.is_user_rebate=0
            AND a.user_rebate &gt; 0

        </where>
         and a.del_flag = 0
         ORDER BY a.order_date DESC
        LIMIT #{startIndex},#{pageSize}
    </select>
       <!--我的订单列表(无返利)-->
    <select id="findNotRebateOrderList"   parameterType="com.doooly.business.myorder.po.OrderPoReq" resultMap="orderListMap">
        SELECT
         <include refid="order_column_sql"/>
        FROM ad_order_report a
        LEFT JOIN ad_business b ON b.id = a.bussiness_id
        LEFT JOIN ad_business_store abs ON a.stores_id = abs.store_number  AND a.bussiness_id = abs.business_id
        LEFT JOIN ad_order_source aos ON a.order_number = aos.order_number
        <where>
            a.user_id = #{userId}
  			<if test="businessId != null and businessId != ''">
                AND 
                a.bussiness_id =#{businessId}
                
            </if>
            <if test="beginOrderDate != null and beginOrderDate != ''">
                AND a.order_date &gt;= #{beginOrderDate}
            </if>
            <if test="endOrderDate != null and endOrderDate != ''">
                AND a.order_date &lt;= #{endOrderDate}
            </if>
			AND (a.type in (99,5) or (a.type  = 1 AND  (a.user_rebate &lt;= 0  or  a.user_rebate is null)))
        </where>
         and a.del_flag = 0
         ORDER BY a.order_date DESC
        LIMIT #{startIndex},#{pageSize}
    </select>

















      <!--统计我的订单列表(所有订单，最近订单，最近到账)-->
    <select id="countALLOrder" parameterType="com.doooly.business.myorder.po.OrderPoReq" resultType="java.lang.Long">
    	SELECT
         	count(a.id)
        FROM ad_order_report a
        LEFT JOIN ad_business b ON b.id = a.bussiness_id
        LEFT JOIN ad_business_store abs ON a.stores_id = abs.store_number  AND a.bussiness_id = abs.business_id
     	 LEFT JOIN ad_order_source aos ON a.order_number = aos.order_number
        <where>
             a.user_id = #{userId}
			<if test="businessId != null and businessId != ''">
                AND 
                a.bussiness_id =#{businessId}
                
            </if>
            <if test="beginOrderDate != null and beginOrderDate != ''">
                AND a.order_date &gt;= #{beginOrderDate}
            </if>
            <if test="endOrderDate != null and endOrderDate != ''">
                AND a.order_date &lt;= #{endOrderDate}
            </if>
            <if test="isUserRebate !=null and  isUserRebate!=''">
            	AND  a.is_user_rebate = #{isUserRebate}
            </if>
            and a.del_flag = 0
        </where>

    </select>

     <!--统计我的订单列表(最近到账)-->
    <select id="countLatestOrderAmount" parameterType="com.doooly.business.myorder.po.OrderPoReq" resultType="java.lang.Long">
         SELECT
          count(a.id)
        FROM ad_order_report a
        LEFT JOIN ad_business b ON b.id = a.bussiness_id
        LEFT JOIN ad_business_store abs ON a.stores_id = abs.store_number  AND a.bussiness_id = abs.business_id
        LEFT JOIN ad_order_source aos ON a.order_number = aos.order_number
        <where>
            a.user_id = #{userId}
            <if test="businessId != null and businessId != ''">
                AND 
                a.bussiness_id =#{businessId}
                
            </if>
            <if test="beginOrderDate != null and beginOrderDate != ''">
                AND a.order_date &gt;= #{beginOrderDate}
            </if>
            <if test="endOrderDate != null and endOrderDate != ''">
                AND a.order_date &lt;= #{endOrderDate}
            </if>
            AND a.type = 1
            AND a.is_user_rebate=0
            AND a.user_rebate &gt; 0

        </where>
         and a.del_flag = 0

    </select>
       <!--统计我的订单列表(无返利)-->
    <select id="countNotRebateOrder"   parameterType="com.doooly.business.myorder.po.OrderPoReq" resultType="java.lang.Long">
        SELECT
        	count(a.id)
        FROM ad_order_report a
        LEFT JOIN ad_business b ON b.id = a.bussiness_id
        LEFT JOIN ad_business_store abs ON a.stores_id = abs.store_number  AND a.bussiness_id = abs.business_id
        LEFT JOIN ad_order_source aos ON a.order_number = aos.order_number
        <where>
         	 a.user_id = #{userId}
			<if test="businessId != null and businessId != ''">
                AND 
                a.bussiness_id =#{businessId}
                
            </if>
            <if test="beginOrderDate != null and beginOrderDate != ''">
                AND a.order_date &gt;= #{beginOrderDate}
            </if>
            <if test="endOrderDate != null and endOrderDate != ''">
                AND a.order_date &lt;= #{endOrderDate}
            </if>
            AND (a.type in (99,5) or (a.type  = 1 AND  (a.user_rebate &lt;= 0  or  a.user_rebate is null) ))
        </where>
         and a.del_flag = 0

    </select>


     <sql id="getOrderDetailColumns">
        a.id AS "id",
        a.order_number AS "orderNumber",
        a.total_mount AS "totalMount",
        a.total_price AS "totalPrice",
        a.order_date AS "orderDate",
         a.user_id AS "userId",
          a.bussiness_id AS "businessId",
        a.state AS "state",
        a.type AS "type",
        a.is_user_rebate AS "isUserRebate",
         a.bussiness_id AS "businessId",
        IFNULL(a.user_rebate,0.00) AS "userRebate",
        IFNULL(a.user_return_amount,0.00) AS "userReturnAmount",
        a.is_business_rebate AS "isBusinessRebate",
        IFNULL(a.business_rebate_amount,0.00) AS "businessRebateAmount",
        a.billing_state AS "billingState",
        a.del_flag AS "delFlag",
        a.is_source AS "isSource",
        b.company AS "company",
        b.logo AS "logo",
        abs.store_name AS "storeName",
        a.total_price-a.total_mount AS "savePrice",
        a.product_type AS "productType",
        a.consignee_mobile AS "consigneeMobile",
        a.service_charge AS "serviceCharge",
        a.voucher AS "voucher",
        a.remarks,
        IFNULL(aos.cash_desk_source,'m') AS "cashDeskSource"
    </sql>



      <select id="getOrderDetail"  parameterType="com.doooly.business.myorder.po.OrderDetailPoReq"  resultType="com.doooly.business.myorder.po.OrderDetailReport">
        SELECT
        <include refid="getOrderDetailColumns"/>
        FROM ad_order_report a
        LEFT JOIN ad_order_source aos ON a.order_number = aos.order_number
        <include refid="OrderDetailInfoJoins"/>
        WHERE  a.id = #{orderId} and a.user_id=#{userId}
    </select>


      <select id="findOrderdDetailSum" parameterType="com.doooly.business.myorder.po.OrderPoReq" resultType="java.util.Map">
        SELECT
        DATE_FORMAT(order_date,'%Y-%m') 'orderDate',
        SUM(a.total_mount) AS "totalMonthMount",
        SUM( a.total_price-a.total_mount) AS "totalMonthsaveMount"
        FROM ad_order_report a
        <where>
           1=1

            <if test=" userId !=null and userId != ''">
                AND a.user_id = #{userId}
            </if>

           AND a.type=1 AND 	a.del_flag = 0

        </where>
        GROUP BY YEAR (order_date), MONTH (order_date)
        ORDER BY a.order_date DESC
    </select>

	<select id="getLatestOrderTotal" parameterType="com.doooly.business.myorder.po.OrderPoReq" resultType="java.lang.Integer">
  		SELECT
			count(1) AS "total"
		FROM ad_order_report a
		<where>
             a.user_id = #{userId}
			<if test="businessId != null and businessId != ''">
                AND 
                a.bussiness_id =#{businessId}
                
            </if>
           
        </where>
         and a.del_flag = 0

  	</select>
  	<select id="getLatestAmountTotal" parameterType="com.doooly.business.myorder.po.OrderPoReq" resultType="java.lang.Integer">
  		SELECT
			 count(1) AS "total"
		FROM ad_order_report a
		 <where>
            a.user_id = #{userId}
            <if test="businessId != null and businessId != ''">
                AND 
                a.bussiness_id =#{businessId}
                
            </if>
           
            AND a.type = 1
			 AND a.is_user_rebate=0
            AND a.user_rebate &gt; 0

        </where>
         and a.del_flag = 0
  	</select>
  	<select id="getNotRebateOrderTotal" parameterType="com.doooly.business.myorder.po.OrderPoReq" resultType="java.lang.Integer">
  		SELECT
			 count(1) AS "total"
		FROM ad_order_report a
		<where>
         	 a.user_id = #{userId}
			<if test="businessId != null and businessId != ''">
                AND 
                a.bussiness_id =#{businessId}
                
            </if>

			AND (a.type in (99,5) or (a.type  = 1 AND (a.user_rebate &lt;= 0  or  a.user_rebate is null) ))
        </where>
         and a.del_flag = 0
  	</select>
  	<update id="deleteOrder" parameterType="com.doooly.business.myorder.po.OrderDetailPoReq">
		update ad_order_report set	del_flag =  1,update_date = now()
		where id = #{orderId} and user_id=#{userId}
	</update>

    <insert id="insertAdBigOrder" parameterType="com.doooly.business.order.vo.AdOrderBig">
        INSERT INTO ad_order_big (
          id,
          user_id,
          total_amount,
          total_price,
          order_date,
          state,
          is_source,
          remarks,
          update_date,
          create_date
        )
        VALUES
          (
            #{id},
            #{userId},
            #{totalAmount},
            #{totalPrice},
            now(),
            #{state},
            #{isSource},
            #{remarks},
            now(),
            now()
          )
    </insert>

    <select id="getOrders" resultMap="orderMap" parameterType="java.lang.String">
        select
            <include refid="getAdOrderReportColumns" />,
            <include refid="adOrderDetailColumns" />
        from
            ad_order_report o,ad_order_detail d
        <where>
            <if test="bigOrderNumber != null and bigOrderNumber != ''">
                and o.order_number = #{bigOrderNumber}
            </if>
        </where>
    </select>

    <select id="getAdOrderBig" resultType="com.doooly.business.order.vo.AdOrderBig" parameterType="com.doooly.business.order.vo.AdOrderBig">
        SELECT
          id,
          user_id,
          total_amount,
          total_price,
          order_date,
          state,
          is_source,
          remarks,
          update_date,
          create_date
        FROM ad_order_big
        <where>
            <if test="id != null and id != ''">
               AND id = #{id}
            </if>
        </where>
    </select>
</mapper>